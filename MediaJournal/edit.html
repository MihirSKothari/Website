<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Media Item</title>
  <style>
    /* (Same styles as you had) */
    body {
      font-family: sans-serif;
      background: #16181d;
      color: #ecedef;
      max-width: 700px;
      margin: 2em auto;
      padding: 1em;
    }
    h1, h2 {
      border-bottom: 1px solid #444;
      padding-bottom: 0.3em;
    }
    form {
      background: #22242a;
      padding: 1em;
      border-radius: 8px;
      margin-top: 1em;
    }
    label {
      display: block;
      margin: 0.8em 0 0.3em;
    }
    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 0.6em;
      border-radius: 4px;
      border: 1px solid #444;
      background: #292a33;
      color: #fff;
      box-sizing: border-box;
    }
    .select-btn {
      padding: 0.5em 1em;
      margin-right: 1em;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      background: #4346ff;
      display: inline-block;
      user-select: none;
    }
    .select-btn.selected {
      background: #27ca60;
    }
    #stars {
      display: flex;
      flex-direction: row;
      align-items: center;
    }
    #stars .star {
      cursor: pointer;
      color: #fff;
      opacity: 0.33;
      font-size: 1.8em;
      margin: 0 0.1em;
      transition: color 0.2s, opacity 0.2s;
      user-select: none;
    }
    #stars .star.selected {
      opacity: 1;
    }
    @media (max-width: 480px) {
      #stars .star {
        font-size: 1.2em;
      }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      #stars .star {
        font-size: 1.5em;
      }
    }
    @media (min-width: 769px) {
      #stars .star {
        font-size: 1.8em;
      }
    }
    .btn {
      padding: 0.55em 2em;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      margin-right: 1em;
      user-select: none;
    }
    .btn-primary {
      background: #27ca60;
    }
    .btn-secondary {
      background: #4346ff;
    }
    #poster {
      display: block;
      max-width: 150px;
      border-radius: 5px;
      margin: 1em 0;
    }
    .checkbox-label {
      user-select: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-top: 1em;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #message {
      margin-top: 1em;
      padding: 0.5em;
      border-radius: 5px;
      display: none;
      font-weight: bold;
    }
    #message.success {
      background: #27ca60;
      color: white;
    }
    #message.error {
      background: #ff665c;
      color: white;
    }
  </style>
</head>

<body>
  <h1>Edit Media Item</h1>
  <div class="header">
    <div id="title" style="font-weight:bold; font-size:1.5em;">Loading...</div>
  </div>
  <img id="poster" src="" alt="Poster" />
  
  <form id="editForm">
    <div style="margin-bottom: 1em;">
      <button type="button" class="select-btn" data-list="watched" id="watchedBtn">Watched</button>
      <button type="button" class="select-btn" data-list="toWatch" id="toWatchBtn">To Watch</button>
    </div>

    <label for="dateWatched">Date Watched:</label>
    <input type="date" id="dateWatched" name="dateWatched" />

    <label>Star Rating:</label>
    <div id="stars"></div>

    <label class="checkbox-label">
      <input type="checkbox" id="reWatch" name="reWatch" /> Mark for Rewatch
    </label>

    <div style="margin-top:1.5em;">
      <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>

  <div id="message"></div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy7xTfb_uUN5QbOZrici11BFTVq2NIVEbObdt0hmgppYtUkl7K8Fs7nET-IuxHUHnVnA/exec';
    const params = new URLSearchParams(window.location.search);
    const idParam = params.get('id');
    const titleDiv = document.getElementById('title');
    const posterImg = document.getElementById('poster');
    const watchedBtn = document.getElementById('watchedBtn');
    const toWatchBtn = document.getElementById('toWatchBtn');
    const dateInput = document.getElementById('dateWatched');
    const reWatchCheckbox = document.getElementById('reWatch');
    const starsContainer = document.getElementById('stars');
    const cancelBtn = document.getElementById('cancelBtn');
    const editForm = document.getElementById('editForm');
    const messageDiv = document.getElementById('message');

    const STAR_VALUES = [1,2,3,4,5,6,7,8,9,10];
    let selectedRating = 0;

    function shadeStars(uptoValue) {
      Array.from(starsContainer.children).forEach(star => {
        const starValue = parseInt(star.dataset.value);
        if (uptoValue && starValue <= uptoValue) {
          star.classList.add('selected');
        } else {
          star.classList.remove('selected');
        }
      });
    }

    function setRating(r) {
      if (selectedRating === r) {
        // toggle off rating if same star clicked again
        selectedRating = 0;
      } else {
        selectedRating = r;
      }
      shadeStars(selectedRating);
    }

    // Create star elements with toggle behavior
    STAR_VALUES.forEach(value => {
      const star = document.createElement('span');
      star.className = 'star';
      star.textContent = 'â˜…';
      star.dataset.value = value;
      star.addEventListener('click', () => {
        setRating(value);
      });
      starsContainer.appendChild(star);
    });

    function selectList(list) {
      if (list === 'watched') {
        watchedBtn.classList.add('selected');
        toWatchBtn.classList.remove('selected');
      } else {
        toWatchBtn.classList.add('selected');
        watchedBtn.classList.remove('selected');
      }
    }

    watchedBtn.addEventListener('click', () => selectList('watched'));
    toWatchBtn.addEventListener('click', () => selectList('toWatch'));

    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = type; // "success" or "error"
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 4000);
    }

    if (!idParam) {
      showMessage('No media item ID specified.', 'error');
      setTimeout(() => window.location.href = 'index.html', 1500);
    } else {
      fetch(`${APPS_SCRIPT_URL}?id=${encodeURIComponent(idParam)}`)
        .then(res => {
          if (!res.ok) throw new Error(`Failed to fetch data: ${res.status}`);
          return res.json();
        })
        .then(data => {
          titleDiv.textContent = data.title || 'Untitled';
          posterImg.src = data.poster || '';
          if (data.watched === true || data.watched === 'TRUE' || data.watched === 'true') {
            selectList('watched');
          } else {
            selectList('toWatch');
          }
          if (data.timestamp) {
            const d = new Date(data.timestamp);
            dateInput.value = d.toISOString().split('T')[0];
          } else {
            dateInput.value = '';
          }
          setRating(data.rating || 0);
          reWatchCheckbox.checked = data.reWatch === true || data.reWatch === 'TRUE';
        })
        .catch(err => {
          showMessage('Error loading item: ' + err.message, 'error');
        });
    }

    cancelBtn.addEventListener('click', () => {
      window.history.back();
    });

    editForm.addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData();
      formData.append('id', idParam);
      formData.append('watched', watchedBtn.classList.contains('selected'));
      formData.append('toWatch', toWatchBtn.classList.contains('selected'));
      formData.append('timestamp', dateInput.value ? new Date(dateInput.value).toISOString() : '');
      formData.append('rating', selectedRating);
      formData.append('reWatch', reWatchCheckbox.checked);

      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        if (result.result === 'success') {
          showMessage('Entry updated successfully!', 'success');
          setTimeout(() => window.location.href = 'index.html', 1500);
        } else {
          showMessage('Failed to update entry: ' + (result.message || 'Unknown error'), 'error');
        }
      } catch (err) {
        showMessage('Error updating entry: ' + err.message, 'error');
      }
    });
  </script>
</body>
</html>
