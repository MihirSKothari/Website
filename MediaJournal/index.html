<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Media Journal</title>
    <style>
        body {
            font-family: sans-serif;
            background: #16181d;
            color: #ecedef;
            max-width: 700px;
            margin: 2em auto;
            padding: 1em;
        }

        #viewlist {
            display: none;
        }

        h1,
        h2 {
            border-bottom: 1px solid #444;
            padding-bottom: 0.3em;
        }

        #addFormContainer {
            margin: 1em 0;
        }

        #addForm {
            margin-top: 1em;
            background: #22242a;
            padding: 1em;
            border-radius: 8px;
            display: none;
        }

        #addForm input[type=text] {
            width: 100%;
            padding: 0.6em;
            margin-bottom: 1em;
            border-radius: 4px;
            border: 1px solid #444;
            background: #292a33;
            color: #fff;
        }

        .select-btn {
            padding: 0.5em 1em;
            margin-right: 1em;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            background: #4346ff;
        }

        .select-btn.selected {
            background: #27ca60;
        }

        #submitBtn {
            padding: 0.55em 2em;
            background: #27ca60;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }

        #stars .star {
            cursor: pointer;
            color: #fff;
            /* solid white for selected */
            opacity: 0.33;
            /* outline style implemented by opacity */
            font-size: 1.8em;
            /* default star size */
            transition: color 0.2s, opacity 0.2s;
            margin: 0 0.1em;
        }

        #stars .star.selected {
            opacity: 1;
        }

        @media (max-width: 480px) {
            #stars .star {
                font-size: 1.2em;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            #stars .star {
                font-size: 1.5em;
            }
        }

        @media (min-width: 769px) {
            #stars .star {
                font-size: 1.8em;
            }
        }

        #message {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.7);
  color: #ecedef;
  padding: 0.6em 1.2em;
  border-radius: 8px;
  font-weight: bold;
  z-index: 1000;
  display: none;
  align-items: center;
  gap: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

#spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #27ca60;
  border-radius: 50%;
  width: 14px;
  height: 14px;
  animation: spin 1s linear infinite;
  display: inline-block;
}

        #message.success {
            background: #27ca60;
            color: white;
        }

        #message.error {
            background: #ff665c;
            color: white;
        }

        .entry {
            display: flex;
            align-items: center;
            position: relative;
            padding: 0.8em;
            margin: 1em 0;
            border-radius: 7px;
            background-color: #552222;
            /* Example background, adjust per mediaType */
        }

        .entry.movie {
            background-color: #223355;
            /* Subtle blue */
        }

        .entry.tv {
            background-color: #552222;
            /* Subtle red */
        }

        .entry img {
            width: 64px;
            height: 96px;
            border-radius: 5px;
            margin-right: 1.3em;
            flex-shrink: 0;
            z-index: 1;
        }

        .info {
            flex: 1;
        }

        .date {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 0.2em;
        }

        .side-bar1 {
            position: absolute;
            right: 36px;
            top: 0;
            bottom: 0;
            width: 55px;
            display: block;
            user-select: none;
            z-index: 2;
            overflow: visible;
            padding: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .rating-right {
            user-select: none;
            white-space: nowrap;
            margin-left: 10px;
            z-index: 1;
            user-select: none;
            color: #fff;
        }

        .rewatch-label {
            position: absolute;
            top: 5%;
            right: 5%;
            font-size: 0.75em;
            user-select: none;
            pointer-events: none;
            white-space: nowrap;
        }

        .side-bar2 {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 36px;
            background-color: rgba(255, 255, 255, 0.1);
            border-top-right-radius: 7px;
            border-bottom-right-radius: 7px;
            display: block;
            user-select: none;
            z-index: 2;
            overflow: visible;
            padding: 0;
        }

        .type-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 0.75em;
            font-weight: bold;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            letter-spacing: 1px;
            text-transform: uppercase;
            user-select: none;
            pointer-events: none;
            text-align: center;
            width: auto;
            white-space: nowrap;
            z-index: 2;
        }

        .edit-icon {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translateX(-50%);
            cursor: pointer;
            user-select: none;
            text-decoration: none;
            transition: stroke 0.2s;
            z-index: 3;
        }

        /* Target the SVG element inside .edit-icon for stroke color change */
        .edit-icon svg {
            stroke: #bbb;
            transition: stroke 0.2s;
        }

        /* On hover of .edit-icon, change the svg stroke color */
        .edit-icon:hover svg {
            stroke: #fff
        }

        /* Add rewatch mark styling */
        .rewatch-mark {
            background-color: #ffcb05;
            color: #222;
            font-weight: bold;
            padding: 0 6px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
            user-select: none;
            vertical-align: middle;
        }

        /* Spinner animation for banner */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <h1>Media Journal</h1>
    <div id="loading" style="font-weight:bold; font-size:1.5em;">Loading...</div>
    <div id="viewlist">
        <div id="addFormContainer">
            <button id="showAddBtn" class="select-btn">Add Movie / Show</button>
            <form id="addForm">
                <input name="tmdbLink" id="tmdbInput" type="text"
                    placeholder="Paste TMDB link (e.g. https://www.themoviedb.org/movie/550-fight-club)" required />
                <div style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap;">
                    <button type="button" class="select-btn" data-list="watched" id="watchedBtn">Watched</button>
                    <button type="button" class="select-btn" data-list="toWatch" id="toWatchBtn">To Watch</button>
                    <div id="stars" style="display: flex; flex-direction: row; align-items: center;"></div>
                </div>
                <br />
                <button type="submit" id="submitBtn">Submit</button>
            </form>
            <div id="message"></div>
        </div>
        <h2>Watched</h2>
        <div id="watchedList"></div>
        <h2>To Watch</h2>
        <div id="toWatchList"></div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy7xTfb_uUN5QbOZrici11BFTVq2NIVEbObdt0hmgppYtUkl7K8Fs7nET-IuxHUHnVnA/exec';
                const LOCAL_JSON_PATH = './media-data.json'; // Local JSON in same folder
                const cacheBuster = Date.now();
                const localJsonUrl = `${LOCAL_JSON_PATH}?v=${cacheBuster}`;

                const showAddBtn = document.getElementById('showAddBtn');
                const addForm = document.getElementById('addForm');
                const tmdbInput = document.getElementById('tmdbInput');
                const watchedBtn = document.getElementById('watchedBtn');
                const toWatchBtn = document.getElementById('toWatchBtn');
                const submitBtn = document.getElementById('submitBtn');
                const messageDiv = document.getElementById('message');
                const starsContainer = document.getElementById('stars');
                const watchedListDiv = document.getElementById('watchedList');
                const toWatchListDiv = document.getElementById('toWatchList');

                let selectedRating = null;
                const STAR_VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

                // Generate star rating inputs
                starsContainer.innerHTML = '';
                STAR_VALUES.forEach(value => {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.innerHTML = '★';
                    star.dataset.value = value;
                    star.addEventListener('click', () => {
                        if (selectedRating === value) {
                            selectedRating = null;
                        } else {
                            selectedRating = value;
                        }
                        shadeStars(selectedRating);
                    });
                    starsContainer.appendChild(star);
                });

                function shadeStars(uptoValue) {
                    Array.from(starsContainer.children).forEach(star => {
                        const starValue = parseInt(star.dataset.value);
                        if (uptoValue && starValue <= uptoValue) {
                            star.classList.add('selected');
                        } else {
                            star.classList.remove('selected');
                        }
                    });
                }

                // Show/hide add form
                showAddBtn.onclick = () => {
                    if (addForm.style.display === 'block') {
                        addForm.style.display = 'none';
                        messageDiv.style.display = 'none';
                    } else {
                        addForm.style.display = 'block';
                        tmdbInput.focus();
                    }
                };

                // Switch watched/toWatch buttons
                let selectedList = 'watched';
                function selectList(list) {
                    selectedList = list;
                    watchedBtn.classList.toggle('selected', list === 'watched');
                    toWatchBtn.classList.toggle('selected', list === 'toWatch');
                }
                watchedBtn.onclick = () => selectList('watched');
                toWatchBtn.onclick = () => selectList('toWatch');
                selectList(selectedList);

                // Render media items in container
                function renderList(items, container) {
                    container.innerHTML = '';
                    items.forEach(item => {
                        const mediaTypeClass = item.mediaType === 'movie' ? 'movie' : (item.mediaType === 'tv' ? 'tv' : '');
                        const ratingDisplay = (item.rating === undefined || item.rating === null || item.rating === '')
                            ? '/' + '★'
                            : item.rating + '★';
                        const idParam = encodeURIComponent(item.rowId || item.mediaId);

                        const div = document.createElement('div');
                        div.className = 'entry ' + mediaTypeClass;
                        div.style.position = 'relative';
                        div.innerHTML = `
                                <img src="${item.poster}" alt="${item.title} poster" />
                                <div class="info">
                                    <div style="font-weight:bold">${item.title}</div>
                                    <div class="date">${item.timestamp ? new Date(item.timestamp).toLocaleDateString() : 'Unknown'}</div>
                                </div>
                                <div class="side-bar1">
                                    <div class="rating-right">${ratingDisplay}</div>
                                    ${item.reWatch === true || item.reWatch === 'TRUE' || item.reWatch === 'true' ? '<div class="rewatch-label">Rewatch</div>' : ''}
                                </div>
                                <div class="side-bar2">
                                    <a href="edit.html?id=${idParam}" class="edit-icon" title="Edit item" aria-label="Edit">
                                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M15.5 5.5L18.3 8.3M3 21L3.04 20.6C3.21 19.5 3.3 18.9 3.49 18.3C3.6 17.9 3.89 17.4 4.18 17C4.5 16.5 4.92 16.1 5.76 15.2L17.4 3.59C18.19 2.81 19.46 2.81 20.23 3.59C21.02 4.37 21.02 5.64 20.23 6.41L8.38 18.28C7.61 19 7.23 19.42 6.8 19.7C6.41 20 6 20.2 5.56 20.4C5.07 20.6 4.54 20.7 3.48 20.9L3 21Z" />
                                        </svg>
                                    </a>
                                    <div class="type-label">${mediaTypeClass ? mediaTypeClass.toUpperCase() : ''}</div>
                                </div>
                                `;
                        container.appendChild(div);
                    });
                }

                // Show banner with spinner for checking updates
                function showCheckingBanner() {
  messageDiv.textContent = 'Checking for latest updates... ';
  messageDiv.className = '';
  messageDiv.style.display = 'inline-flex'; // shows as inline-flex for proper layout

  if (!document.getElementById('spinner')) {
    const spinner = document.createElement('span');
    spinner.id = 'spinner';
    messageDiv.appendChild(spinner);
  }
}

                // Remove spinner and optionally hide message after a delay
                function removeSpinnerAndMaybeHide(delayMs = 0) {
  const spinner = document.getElementById('spinner');
  if (spinner) spinner.remove();
  if (delayMs > 0) {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, delayMs);
  } else {
    messageDiv.style.display = 'none';
  }
}

                // Show message banner (generic)
                function showMessage(text, type) {
                    messageDiv.textContent = text;
                    messageDiv.className = type || '';
                    messageDiv.style.display = 'block';
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 4000);
                }

                // Load local json and display it
                async function loadLocalData() {
                    try {
                        const response = await fetch(localJsonUrl, { cache: 'no-store' });
                        if (!response.ok) throw new Error('Failed to load local JSON');
                        const items = await response.json();
                        displayItems(items);
                    } catch (error) {
                        console.error('Error loading local data:', error);
                        showMessage('Error loading local data.', 'error');
                    }
                }


                // Load and display media from Google Sheets
                async function displayItems(items) {
                    const watchedItems = items.filter(item => item.watched === true || item.watched === 'TRUE' || item.watched === 'true');
                    const toWatchItems = items.filter(item => item.toWatch === true || item.toWatch === 'TRUE' || item.toWatch === 'true');
                    renderList(watchedItems, watchedListDiv);
                    renderList(toWatchItems, toWatchListDiv);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('viewlist').style.display = 'block';
                }


                // Fetch latest data from Google Apps Script, compare, update UI
                async function checkForUpdates() {
                    try {
                        showCheckingBanner();

                        const [localData, latestData] = await Promise.all([
                            fetch(localJsonUrl, { cache: 'no-store' }).then(r => r.json()),
                            fetch(APPS_SCRIPT_URL, { cache: 'no-store' }).then(r => r.json())
                        ]);

                        // Compare stringified data ignoring milliseconds in timestamps for robustness
                        const normalizeDates = items => items.map(item => {
                            if (item.timestamp) {
                                // Remove ms by truncating ISO string at seconds
                                item.timestamp = item.timestamp.toString().slice(0, 19) + 'Z';
                            }
                            return item;
                        });

                        const normalizedLocal = JSON.stringify(normalizeDates(localData));
                        const normalizedLatest = JSON.stringify(normalizeDates(latestData));

                        if (normalizedLocal === normalizedLatest) {
                            messageDiv.textContent = 'No pending updates';
                            messageDiv.className = 'success';
                            removeSpinnerAndMaybeHide(5000);
                        } else {
                            displayItems(latestData);
                            messageDiv.textContent = 'Latest updates loaded';
                            messageDiv.className = 'success';
                            removeSpinnerAndMaybeHide(5000);
                        }
                    } catch (error) {
                        console.error('Error checking for updates:', error);
                        messageDiv.textContent = 'Error checking for updates';
                        messageDiv.className = 'error';
                        messageDiv.style.display = 'block';
                    }
                }

                // Initialize page: load local data then check for updates async
                loadLocalData().then(checkForUpdates);



                // Show message banner
                function showMessage(text, type) {
                    messageDiv.textContent = text;
                    messageDiv.className = type;
                    messageDiv.style.display = 'block';
                    setTimeout(() => { messageDiv.style.display = 'none'; }, 4000);
                }

                // Form submission
                addForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const tmdbLink = tmdbInput.value.trim();
                    if (!tmdbLink) {
                        showMessage('Please enter a TMDB link.', 'error');
                        return;
                    }
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const formData = new FormData();
                    formData.append('tmdbLink', tmdbLink);
                    formData.append('listType', selectedList);
                    formData.append('rating', selectedRating || '');
                    formData.append('reWatch', false);

                    try {
                        const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                        const result = await response.json();
                        if (result.result === 'duplicate') {
                            showMessage('This entry already exists.', 'error');
                        } else if (result.result === 'success') {
                            showMessage('Added successfully!', 'success');
                            addForm.reset();
                            addForm.style.display = 'none';
                            displayItems();
                        } else {
                            showMessage('Failed to add entry.', 'error');
                        }
                    } catch (err) {
                        showMessage('Error submitting data.', 'error');
                        console.error(err);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit';
                    }
                });

            });
        </script>
    </div>
</body>

</html>