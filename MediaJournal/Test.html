<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Media Journal</title>
	<style>
		body {
			font-family: sans-serif;
			background: #16181d;
			color: #ecedef;
			max-width: 700px;
			margin: 2em auto;
			padding: 1em;
		}

		h1,
		h2 {
			border-bottom: 1px solid #444;
			padding-bottom: 0.3em;
		}

		#addFormContainer {
			margin: 1em 0;
		}

		#addForm {
			margin-top: 1em;
			background: #22242a;
			padding: 1em;
			border-radius: 8px;
			display: none;
		}

		#addForm input[type=text] {
			width: 100%;
			padding: 0.6em;
			margin-bottom: 1em;
			border-radius: 4px;
			border: 1px solid #444;
			background: #292a33;
			color: #fff;
		}

		.select-btn {
			padding: 0.5em 1em;
			margin-right: 1em;
			border: none;
			color: #fff;
			cursor: pointer;
			border-radius: 4px;
			background: #4346ff;
		}

		.select-btn.selected {
			background: #27ca60;
		}

		#submitBtn {
			padding: 0.55em 2em;
			background: #27ca60;
			border: none;
			border-radius: 4px;
			color: #fff;
			cursor: pointer;
		}

		#stars .star {
			cursor: pointer;
			color: #fff;
			/* solid white for selected */
			opacity: 0.33;
			/* outline style implemented by opacity */
			font-size: 1.8em;
			/* default star size */
			transition: color 0.2s, opacity 0.2s;
			margin: 0 0.1em;
		}

		#stars .star.selected {
			opacity: 1;
		}

		@media (max-width: 480px) {
			#stars .star {
				font-size: 1.2em;
			}
		}

		@media (min-width: 481px) and (max-width: 768px) {
			#stars .star {
				font-size: 1.5em;
			}
		}

		@media (min-width: 769px) {
			#stars .star {
				font-size: 1.8em;
			}
		}

		.entry {
			display: flex;
			align-items: center;
			margin: 1em 0;
			padding: 0.8em;
			border-radius: 7px;
			position: relative;
			/* Default background, will be overridden by type-specific */
			background-color: #1e2537;
		}

		.entry.movie {
			background-color: #223355;
			/* Subtle blue */
		}

		.entry.tv {
			background-color: #552222;
			/* Subtle red */
		}

		.entry img {
			width: 64px;
			height: 96px;
			object-fit: cover;
			border-radius: 5px;
			margin-right: 1.3em;
			flex-shrink: 0;
			z-index: 1;
		}

		.info {
			flex: 1;
		}

		.date {
			font-size: 0.9em;
			color: #aaa;
		}

		#message {
			margin-top: 1em;
			padding: 0.5em;
			border-radius: 5px;
			display: none;
		}

		#message.success {
			background: #27ca60;
			color: white;
		}

		#message.error {
			background: #ff665c;
			color: white;
		}

		.type-label {
			position: absolute;
			right: 0;
			top: 0;
			bottom: 0;
			width: 24px;
			background-color: rgba(255, 255, 255, 0.1);
			color: #ccc;
			font-size: 0.75em;
			font-weight: bold;
			writing-mode: vertical-lr;
			text-orientation: mixed;
			display: flex;
			align-items: center;
			justify-content: center;
			border-top-right-radius: 7px;
			border-bottom-right-radius: 7px;
			user-select: none;
			pointer-events: none;
			letter-spacing: 1px;
			text-transform: uppercase;
		}

		.edit-icon {
			position: absolute;
			right: 2px;
			/* Horizontal distance from right edge */
			bottom: 80%;
			/* Position just above the rating display */
			/*transform: translateY(-8px);
			 Slight upward offset */
			font-size: 20px;
			color: #bbb;
			cursor: pointer;
			user-select: none;
			text-decoration: none;
		}
	</style>
</head>

<body>
	<h1>Media Journal</h1>

	<div id="addFormContainer">
		<button id="showAddBtn" class="select-btn">Add Movie / Show</button>

		<form id="addForm">
			<input name="tmdbLink" id="tmdbInput" type="text"
				placeholder="Paste TMDB link (e.g. https://www.themoviedb.org/movie/550-fight-club)" required />
			<div style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap;">
				<button type="button" class="select-btn" data-list="watched" id="watchedBtn">Watched</button>
				<button type="button" class="select-btn" data-list="toWatch" id="toWatchBtn">To Watch</button>
				<div id="stars" style="display: flex; flex-direction: row; align-items: center;"></div>
			</div>
			<br />
			<button type="submit" id="submitBtn">Submit</button>
		</form>

		<div id="message"></div>
	</div>

	<h2>Watched</h2>
	<div id="watchedList"></div>

	<h2>To Watch</h2>
	<div id="toWatchList"></div>

	<script>

		document.addEventListener('DOMContentLoaded', () => {
			const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy7xTfb_uUN5QbOZrici11BFTVq2NIVEbObdt0hmgppYtUkl7K8Fs7nET-IuxHUHnVnA/exec'; // Replace with your Apps Script URL

			// Elements
			const showAddBtn = document.getElementById('showAddBtn');
			const addForm = document.getElementById('addForm');
			const tmdbInput = document.getElementById('tmdbInput');
			const watchedBtn = document.getElementById('watchedBtn');
			const toWatchBtn = document.getElementById('toWatchBtn');
			const submitBtn = document.getElementById('submitBtn');
			const messageDiv = document.getElementById('message');

			// Generate 10 clickable stars
			const starsContainer = document.getElementById('stars');
			let selectedRating = null;
			const STAR_VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

			starsContainer.innerHTML = '';
			STAR_VALUES.forEach(value => {
				const star = document.createElement('span');
				star.className = 'star';
				star.innerHTML = '&#9733;'; // Unicode star ★
				star.dataset.value = value;

				star.addEventListener('click', () => {
					if (selectedRating === value) {
						selectedRating = null; // unselect on click again
					} else {
						selectedRating = value;
					}
					shadeStars(selectedRating);
				});

				starsContainer.appendChild(star);
			});

			function shadeStars(uptoValue) {
				Array.from(starsContainer.children).forEach(star => {
					const starValue = parseInt(star.dataset.value);
					if (uptoValue && starValue <= uptoValue) {
						star.classList.add('selected');
					} else {
						star.classList.remove('selected');
					}
				});
			}
			const watchedListDiv = document.getElementById('watchedList');
			const toWatchListDiv = document.getElementById('toWatchList');

			let selectedList = 'watched'; // default

			function showMessage(text, type) {
				messageDiv.textContent = text;
				messageDiv.className = type;
				messageDiv.style.display = 'block';
				setTimeout(() => { messageDiv.style.display = 'none'; }, 4000);
			}

			// Toggle form visibility
			showAddBtn.onclick = () => {
				if (addForm.style.display === 'block') {
					addForm.style.display = 'none';
					messageDiv.style.display = 'none';
				} else {
					addForm.style.display = 'block';
					tmdbInput.focus();
				}
			};

			// Select watched or toWatch
			function selectList(list) {
				selectedList = list;
				watchedBtn.classList.toggle('selected', list === 'watched');
				toWatchBtn.classList.toggle('selected', list === 'toWatch');
			}
			watchedBtn.onclick = () => selectList('watched');
			toWatchBtn.onclick = () => selectList('toWatch');
			selectList(selectedList);

			// Render media items in container
			// Change this function:
function renderList(items, container) {
  container.innerHTML = '';
  items.forEach(item => {
    const mediaTypeClass = item.mediaType === 'movie' ? 'movie' : (item.mediaType === 'tv' ? 'tv' : '');
    const ratingDisplay = (item.rating === undefined || item.rating === null || item.rating === '') 
      ? '/' 
      : item.rating + '★';

    const div = document.createElement('div');
    div.className = 'entry ' + mediaTypeClass;
    div.style.position = 'relative';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';

    const idParam = encodeURIComponent(item.rowId || item.mediaId);

    div.innerHTML = `
      <div style="display:flex; align-items:center; flex:1;">
        <img src="${item.poster}" alt="${item.title} poster" />
        <div class="info" style="padding-left: 1em;">
          <div style="font-weight:bold">${item.title}</div>
          <div class="date">Added: ${item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Unknown'}</div>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px; margin-right: 30px; user-select: none; white-space: nowrap;">
        <a href="edit.html?id=${idParam}" title="Edit item" class="edit-icon">&#9998;</a>
        <div>${ratingDisplay}</div>
      </div>
      <div class="type-label">${mediaTypeClass ? mediaTypeClass.toUpperCase() : ''}</div>
    `;

    container.appendChild(div);
  });
}



			// And call it like this:

			// Fetch and display all media from Google Sheets via Apps Script
			async function loadMedia() {
				try {
					const response = await fetch(APPS_SCRIPT_URL);
					if (!response.ok) throw new Error('Failed to fetch data');
					const items = await response.json();

					// Separate watched and toWatch lists
					const watchedItems = items.filter(item =>
						item.watched === true || item.watched === 'TRUE' || item.watched === 'true');
					const toWatchItems = items.filter(item =>
						item.toWatch === true || item.toWatch === 'TRUE' || item.toWatch === 'true');

					renderList(watchedItems, watchedListDiv);
					renderList(toWatchItems, toWatchListDiv);

				} catch (err) {
					showMessage('Error loading media list.', 'error');
					console.error(err);
				}
			}

			// Handle form submission
			addForm.addEventListener('submit', async (e) => {
				e.preventDefault();

				const tmdbLink = tmdbInput.value.trim();
				if (!tmdbLink) {
					showMessage('Please enter a TMDB link.', 'error');
					return;
				}

				submitBtn.disabled = true;
				submitBtn.textContent = 'Submitting...';

				// Prepare form data
				const formData = new FormData();
				formData.append('tmdbLink', tmdbLink);
				formData.append('listType', selectedList);
				formData.append('rating', selectedRating || '');

				try {
					const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
					const result = await response.json();

					if (result.result === 'duplicate') {
						showMessage('This entry already exists.', 'error');
					} else if (result.result === 'success') {
						showMessage('Added successfully!', 'success');
						// Clear input and hide form
						addForm.reset();
						addForm.style.display = 'none';

						// Reload list to show new entry
						loadMedia();
					} else {
						showMessage('Failed to add entry.', 'error');
					}
				} catch (err) {
					showMessage('Error submitting data.', 'error');
					console.error(err);
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'Submit';
				}
			});

			// Initial data load
			loadMedia();

		});

	</script>
</body>

</html>